variables:
  http_proxy: $CODE_PROXY
  https_proxy: $CODE_PROXY
  no_proxy: "code.siemens-energy.com,127.0.0.1,localhost,.siemens-energy.com,artifactory.siemens-energy.com,docker-code.siemens-energy.com"
  HTTP_PROXY: $CODE_PROXY
  HTTPS_PROXY: $CODE_PROXY
  NO_PROXY: $no_proxy

stages:
  - build-base-container
  - build-sw360
  - upload-bom

services:
  - couchdb:3.3.3
  
sw360-build-container:
  stage: build-base-container
  image:
    name: gcr.io/kaniko-project/executor:v1.21.1-debug
    entrypoint: [""]  
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - |
     /kaniko/executor \
      --context "${CI_PROJECT_DIR}" \
      --build-arg "http_proxy=${http_proxy}" \
      --build-arg "https_proxy=${https_proxy}" \
      --build-arg "no_proxy=${no_proxy}" \
      --dockerfile "${CI_PROJECT_DIR}/siemens-energy/sw360dev.Dockerfile" \
      --destination "${CI_REGISTRY_IMAGE}:latest" 
  rules:
    - changes:
      - siemens-energy/sw360dev.Dockerfile
  

build-and-test:
  stage: build-sw360
  image: ${CI_REGISTRY_IMAGE}:latest
  variables:
    COUCHDB_USER: "$COUCHDB_TEST_USER"
    COUCHDB_PASSWORD: "$COUCHDB_TEST_PWD"
    #_JAVA_OPTIONS: '-Djdk.util.zip.disableZip64ExtraFieldValidation=true'
    _JAVA_OPTIONS: "-Djdk.net.URLClassPath.disableClassPathURLCheck=true -Djdk.util.zip.disableZip64ExtraFieldValidation=true -DSPDXParser.OnlyUseLocalLicenses=true -Dhttp.proxySet=true -Dhttp.proxyHost=$CODE_PROXY_HOST -Dhttp.proxyPort=$CODE_PROXY_PORT -Dhttps.proxyHost=$CODE_PROXY_HOST -Dhttps.proxyPort=$CODE_PROXY_PORT -Dhttp.nonProxyHosts=localhost|couchdb"
  script:
    - |
      - mkdir -p  /etc/sw360/
    # Create couchdb-test.properties in /etc/sw360 to run testcases
      - echo 'couchdb.url = http://couchdb:5984' > /etc/sw360/couchdb-test.properties
      - echo "couchdb.user = ${COUCHDB_TEST_USER}" >> /etc/sw360/couchdb-test.properties
      - echo "couchdb.password = ${COUCHDB_TEST_PWD}" >> /etc/sw360/couchdb-test.properties

      mvn ${_JAVA_OPTIONS} clean install --no-transfer-progress -P deploy -Dhelp-docs=true -Dbase.deploy.dir=. -Dliferay.deploy.dir=${PWD}/deploy \
        -Dbackend.deploy.dir=${PWD}/deploy/webapps -Drest.deploy.dir=${PWD}/deploy/webapps -DRunComponentVisibilityRestrictionTest=false \
        -DRunPrivateProjectAccessTest=false -DRunRestForceUpdateTest=false -DskipTests